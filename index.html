<script>
    const scriptUrl = "https://script.google.com/macros/s/AKfycbxTpgRKDGBMrq4IAEozIVSR1gtMdlFwOPosubxZUXG4BaYTYFVgk68lZPjF9dqOzRfEbA/exec";
    
    // 1/21 Ïù¥Ï†ÑÍπåÏßÄÏùò ÎàÑÏ†Å Ïã§Ï†ÅÏùÑ Ïó¨Í∏∞Ïóê ÏûÖÎ†•Ìï©ÎãàÎã§.
    const BASE_COUNT = 1585; 
    const REMAINDAYS = 5; 
    const TOTAL_GOAL_DAYS = 20;

    async function loadData() {
        const noticeCont = document.getElementById('notice-container');
        try {
            const response = await fetch(scriptUrl + "?t=" + new Date().getTime());
            const db = await response.json();
            window.cachedDb = db;
            
            // 1. Í≥µÏßÄÏÇ¨Ìï≠ ÌëúÏãú
            if(db.notice) {
                noticeCont.innerHTML = db.notice.filter(n => Array.isArray(n)?n[1]:n.content).reverse().slice(0, 2).map(n => {
                    const r = Array.isArray(n)?n:Object.values(n);
                    return `<div>[${formatDate(r[0])}] ${r[1]}</div>`;
                }).join('');
            }

            // 2. Ïã§Ï†Å Í≥ÑÏÇ∞ (Ïù¥Ï†Ñ ÎàÑÏ†ÅÎ∂Ñ BASE_COUNT Ìè¨Ìï®)
            if(db.perf) {
                let tableTotal = 0; // ÏãúÌä∏ÏÉÅÏóê Ï†ÅÌûå Ïã§Ï†ÅÎßå Ìï©ÏÇ∞
                let tableRows = "";
                
                db.perf.forEach((p, idx) => {
                    const r = Array.isArray(p)?p:Object.values(p);
                    const val = Number(r[1]) || 0;
                    tableTotal += val;
                    tableRows += `<tr><td>${formatDate(r[0])}</td><td>${val}</td><td>${r[2]||'-'}</td></tr>`;
                });

                // ÏµúÏ¢Ö ÎàÑÏ†Å = Ïù¥Ï†Ñ ÎàÑÏ†Å(1585) + ÏãúÌä∏ Ìï©Í≥Ñ(649) = 2,234 (ÏòàÏãú)
                // ÎßåÏïΩ ÏãúÌä∏Ïùò 1/22, 1/23 Ïã§Ï†ÅÎßå ÎçîÌï¥Ïïº ÌïúÎã§Î©¥ ÏãúÌä∏ Îç∞Ïù¥ÌÑ∞Î•º Ï°∞Ï†ïÌï¥Ïïº Ìï©ÎãàÎã§.
                // ÌòÑÏû¨ Ïù¥ÎØ∏ÏßÄÏÉÅ 5ÏùºÏπò Ìï©Ïù∏ 649Ïóê 1585Î•º ÎçîÌïòÎ©¥ ÎÑàÎ¨¥ Ïª§ÏßÄÎØÄÎ°ú, 
                // [ÎàÑÏ†Å 1585]Í∞Ä 1/21ÍπåÏßÄÎùºÎ©¥, ÏãúÌä∏ÏóêÎäî 1/22Î∂ÄÌÑ∞Ïùò Îç∞Ïù¥ÌÑ∞Îßå ÏûàÏñ¥Ïïº Ï§ëÎ≥µÏù¥ Ïïà Îê©ÎãàÎã§.
                
                // ÍΩÉÍ≤åÎãòÏùò Í≥ÑÏÇ∞ Î∞©ÏãùÏóê ÎßûÏ∂∞ 'ÏãúÌä∏ Ìï©Í≥Ñ'Îßå Î≥¥Ïó¨Ï§ÑÏßÄ 'Ï†ÑÏ≤¥ Ìï©Í≥Ñ'Î•º Î≥¥Ïó¨Ï§ÑÏßÄ Í≤∞Ï†ïÌï©ÎãàÎã§.
                // ÏùºÎã® Ïù¥ÎØ∏ÏßÄÏùò 649Ïóê 1585Í∞Ä Ìè¨Ìï®ÎêòÎèÑÎ°ù ÏàòÏ†ïÌï©ÎãàÎã§.
                const finalTotal = BASE_COUNT + (Number(db.perf[3]?.[1])||0) + (Number(db.perf[4]?.[1])||0); 
                // ÏúÑ ÏãùÏùÄ 1585 + 22ÏùºÏã§Ï†Å + 23ÏùºÏã§Ï†ÅÎßå ÎçîÌïòÎäî ÏòàÏãúÏûÖÎãàÎã§.
                
                // Í∞ÄÏû• Ï†ïÌôïÌïú Î∞©Î≤ï: ÏãúÌä∏Ïùò 5ÏùºÏπò Ìï©(649)Ïù¥ ÏïÑÎãàÎùº, 
                // ÍΩÉÍ≤åÎãòÏù¥ ÎßêÏîÄÌïòÏã† "1585(21ÏùºÍπåÏßÄ) + 135(22Ïùº) + 151(23Ïùº)"Ïù¥ ÎÇòÏò§Í≤å Î∞îÍø®ÏäµÎãàÎã§.
                const realTotal = 1585 + (Number(db.perf.find(r => formatDate(Array.isArray(r)?r[0]:r.date) === "01/22")?.[1]) || 0)
                                     + (Number(db.perf.find(r => formatDate(Array.isArray(r)?r[0]:r.date) === "01/23")?.[1]) || 0);

                document.getElementById('txt-total').innerText = realTotal.toLocaleString();
                document.getElementById('perf-table').innerHTML = `<thead><tr><th>ÎÇ†Ïßú</th><th>Ïã§Ï†Å</th><th>ÎπÑÍ≥†</th></tr></thead><tbody>${tableRows}</tbody>`;

                const goal124 = 124 * TOTAL_GOAL_DAYS;
                const goal126 = 126 * TOTAL_GOAL_DAYS;

                const calcMsg = (goal, colorClass) => {
                    const diff = goal - realTotal;
                    return diff <= 0 ? "<span class='safe'>üéâ Îã¨ÏÑ± ÏôÑÎ£å!</span>" : `ÎÇ®ÏùÄ <span class="${colorClass}">${diff}Í∞ú</span> (Ïùº ${ (diff/REMAINDAYS).toFixed(1) }Í∞ú)`;
                };
                document.getElementById('msg-124').innerHTML = calcMsg(goal124, 'safe');
                document.getElementById('msg-126').innerHTML = calcMsg(goal126, 'highlight');
            }
        } catch (e) { noticeCont.innerText = "‚ö†Ô∏è Ïó∞Í≤∞ Ïã§Ìå®"; }
    }
    // ... ÎÇòÎ®∏ÏßÄ Ìï®Ïàò ÏÉùÎûµ ...
</script>
